# Testing

How to test KeyForge. What to test. Coverage targets. No exceptions.

---

## Testing Philosophy

1. **Rust crates are the security boundary.** They get the most rigorous testing. 100% line coverage target. Property-based tests. Fuzzing.
2. **TypeScript packages are the logic layer.** High coverage (90%+). Unit tests for all business logic. Integration tests for adapter wiring.
3. **E2E tests verify the full stack.** Every user-facing flow gets an E2E test on every platform.
4. **Tests are not optional.** No PR merges without passing tests. No code ships without coverage thresholds met.

---

## Test Pyramid

```
         /  E2E Tests  \          ← Few, slow, high confidence
        / Integration    \        ← Medium count, medium speed
       / Unit Tests (TS)   \      ← Many, fast
      / Unit Tests (Rust)    \    ← Many, fast, most critical
     ──────────────────────────
```

---

## Rust Crate Testing

### keyforge-crypto

This is the most critical crate. It handles all cryptography.

**Unit Tests — MUST cover:**

| Module | Tests |
|--------|-------|
| `totp.rs` | RFC 6238 test vectors (all SHA variants). Codes at exact period boundaries. Codes at time=0. Codes at far-future timestamps. Invalid secret handling. All digit lengths (6, 8). All periods (30, 60). |
| `hotp.rs` | RFC 4226 test vectors (Appendix D — the 10 reference values). Counter=0 through counter=9. Counter overflow behavior. Invalid secret handling. |
| `kdf.rs` | Argon2id produces deterministic output for same inputs. Different salts produce different keys. Output length is exactly 32 bytes. Minimum parameters are enforced. |
| `aead.rs` | AES-256-GCM encrypt then decrypt round-trip. Tampered ciphertext fails authentication. Different nonces produce different ciphertext. Wrong key fails decryption. Empty plaintext. Large plaintext (1MB+). |
| `random.rs` | Generated bytes have expected length. Two calls do not produce identical output (probabilistic, run 100 times). |

**RFC 6238 Test Vectors (MUST be implemented):**

From the RFC, using the test secret `12345678901234567890` (ASCII):

| Time (seconds) | Algorithm | Expected Code |
|----------------|-----------|---------------|
| 59 | SHA1 | 94287082 |
| 59 | SHA256 | 46119246 |
| 59 | SHA512 | 90693936 |
| 1111111109 | SHA1 | 07081804 |
| 1111111109 | SHA256 | 68084774 |
| 1111111109 | SHA512 | 25091201 |
| 1111111111 | SHA1 | 14050471 |
| 1111111111 | SHA256 | 67062674 |
| 1111111111 | SHA512 | 99943326 |
| 1234567890 | SHA1 | 89005924 |
| 1234567890 | SHA256 | 91819424 |
| 1234567890 | SHA512 | 93441116 |
| 2000000000 | SHA1 | 69279037 |
| 2000000000 | SHA256 | 90698825 |
| 2000000000 | SHA512 | 38618901 |
| 20000000000 | SHA1 | 65353130 |
| 20000000000 | SHA256 | 77737706 |
| 20000000000 | SHA512 | 47863826 |

These are 8-digit codes (digits=8). Also test with truncation to 6 digits.

**RFC 4226 Test Vectors (MUST be implemented):**

From RFC 4226 Appendix D, using secret `12345678901234567890` (ASCII) with SHA1:

| Counter | HOTP Code |
|---------|-----------|
| 0 | 755224 |
| 1 | 287082 |
| 2 | 359152 |
| 3 | 969429 |
| 4 | 338314 |
| 5 | 254676 |
| 6 | 287922 |
| 7 | 162583 |
| 8 | 399871 |
| 9 | 520489 |

**Property-Based Tests:**

Use a property testing framework (Rust: `proptest` or `quickcheck`):

- For any random secret, algorithm, digits, and time: `generate_totp` always returns a string of exactly `digits` length
- For any random secret: `generate_totp(t)` == `generate_totp(t)` (deterministic)
- For any random secret: `generate_totp(t)` != `generate_totp(t + period)` with high probability
- For any random plaintext: `decrypt(encrypt(plaintext, key, nonce), key, nonce)` == `plaintext`
- For any random plaintext and two different keys: `decrypt(encrypt(plaintext, key1, nonce), key2, nonce)` fails

**Fuzzing (stretch goal):**

Use `cargo-fuzz` to fuzz:
- `otpauth://` URI parsing with random input
- AES-256-GCM decryption with random ciphertext (should never panic, always return error)
- Base32 decoding with random input

### keyforge-vault

**Unit Tests — MUST cover:**

| Module | Tests |
|--------|-------|
| `db.rs` | Open new vault (creates file). Open existing vault. Open with wrong password (fails). Open corrupted file (fails). Close and reopen. |
| `migrations.rs` | Fresh database gets all migrations applied. Already-migrated database is a no-op. Migrations run in order. Schema version is updated. |
| `token.rs` | Insert token. Read all tokens. Read single token by ID. Update token fields. Delete token. Reorder tokens. Insert duplicate ID fails. Delete nonexistent ID is no-op. Bulk insert (import). |
| `export.rs` | Export to encrypted format. Export to plaintext otpauth URIs. Encrypted export can be re-imported. |
| `import.rs` | Import otpauth URI list. Import Google Authenticator protobuf. Import Aegis JSON. Import 2FAS JSON. Import Ente JSON. Malformed input returns error (no panic). |

**Integration Tests:**

- Full round-trip: create vault → add tokens → lock → unlock → read tokens → verify codes match
- Migration upgrade: create vault with schema v1 → close → upgrade to v2 → open → data intact
- Export/import round-trip: add tokens → export encrypted → create new vault → import → tokens match
- Concurrent access: open vault → attempt second open → should fail or queue (no corruption)

### Coverage Targets

| Crate | Line Coverage | Branch Coverage |
|-------|--------------|-----------------|
| keyforge-crypto | 100% | 95%+ |
| keyforge-vault | 95%+ | 90%+ |

Use `cargo-tarpaulin` or `cargo-llvm-cov` for coverage measurement.

### Benchmark Tests

Use `criterion` for benchmarks:

- TOTP generation time (should be < 1ms)
- Argon2id key derivation time (target ~500ms, configurable)
- AES-256-GCM encrypt/decrypt throughput
- Vault open time (includes key derivation + SQLCipher open)
- Bulk token insert (100, 1000 tokens)

### Rust Test Commands

```
cargo test --workspace                    # All crate tests
cargo test -p keyforge-crypto             # Crypto crate only
cargo test -p keyforge-vault              # Vault crate only
cargo test --workspace -- --nocapture     # With stdout output
cargo tarpaulin --workspace --out html    # Coverage report
cargo bench --workspace                   # Benchmarks
```

### Rust CI Requirements

- `cargo test` passes with zero failures
- `cargo clippy -- -D warnings` passes with zero warnings
- `cargo fmt --check` passes (code is formatted)
- `cargo audit` passes (no known vulnerable dependencies)
- Coverage thresholds met (fail CI if below target)

---

## TypeScript Package Testing

### packages/core

**Unit Tests:**

| Module | Tests |
|--------|-------|
| `totp/generate.ts` | Same RFC 6238 test vectors as Rust (verifies JS implementation matches). Edge cases: period boundary, time=0. |
| `hotp/generate.ts` | Same RFC 4226 test vectors. Counter=0 through 9. |
| `uri/parse.ts` | Valid otpauth URI → correct Token object. Missing required fields → error. Extra unknown params → ignored. URL-encoded characters. Special characters in issuer/account. |
| `uri/encode.ts` | Token object → valid otpauth URI. Round-trip: parse(encode(token)) == token. |
| `vault/adapter.ts` | Mock adapter: add, read, update, delete, reorder. |

**Important:** The TypeScript TOTP/HOTP tests MUST use the same RFC test vectors as the Rust tests. Both implementations MUST produce identical output. Any discrepancy is a bug.

### packages/shared

**Unit Tests:**

| Module | Tests |
|--------|-------|
| `utils/formatCode.ts` | "123456" → "123 456". "12345678" → "1234 5678". Empty string. Non-numeric input. |
| `utils/timeLeft.ts` | Returns correct seconds remaining. At exact boundary returns period. Handles different period values. |
| `utils/base32.ts` | Encode/decode round-trip. Standard test vectors. Invalid input returns error. Padding handling. |

### packages/ui

**Component Tests:**

Use a component testing framework appropriate for the chosen UI framework:

| Component | Tests |
|-----------|-------|
| CodeCard | Renders issuer, account, formatted code. Click triggers onCopy. Progress ring reflects timeLeft. Compact mode hides account. |
| ProgressRing | Renders at various progress values. Color changes at thresholds (green/amber/red). Zero progress = empty. Full progress = full circle. |
| VaultLock | Password input works. Submit triggers onUnlock. Biometric button shown when available. Error message shown. Loading state shown. |
| SearchBar | Input updates search text. Clear button clears. Empty state. |
| Toast | Appears with message. Auto-dismisses after duration. Correct type styling. |
| Modal | Renders title and body. Confirm button triggers callback. Cancel triggers callback. Escape closes. Backdrop click closes. |

### TypeScript Coverage Targets

| Package | Line Coverage |
|---------|--------------|
| packages/core | 95%+ |
| packages/shared | 95%+ |
| packages/ui | 85%+ (components are harder to get 100% on) |

---

## End-to-End Tests

### E2E Test Framework

- Desktop: Tauri's test utilities + WebDriver (or Playwright if Tauri supports it)
- Mobile: Appium or Detox (platform-dependent)
- Extension: Playwright with Chrome extension loading
- ALL E2E tests run in CI

### Critical User Flows (MUST have E2E tests)

| Flow | Platforms | What It Tests |
|------|-----------|---------------|
| First launch → create vault | ALL | Onboarding flow, vault creation, password setup |
| Unlock vault with password | ALL | Password entry, key derivation, vault open |
| Unlock vault with biometric | DESKTOP (macOS), MOBILE | Biometric prompt, keychain key retrieval |
| Add token via manual entry | ALL | Form input, validation, vault storage, code generation |
| Add token via QR scan | MOBILE, EXTENSION | Camera/screenshot, QR decode, URI parse, vault storage |
| Add token via URI paste | ALL | Paste input, URI parse, confirmation, vault storage |
| View and copy code | ALL | Code displays correctly, tap copies, clipboard has code, toast shown |
| Code refreshes on period expire | ALL | Wait for period, observe code change, progress ring reset |
| Edit token | ALL | Edit issuer/account, save, verify change persists |
| Delete token | ALL | Delete confirmation, token removed, vault updated |
| Search tokens | ALL | Type in search, list filters, clear restores full list |
| Reorder tokens | DESKTOP, MOBILE | Drag to reorder, order persists after lock/unlock |
| Change master password | ALL | Old password required, new password set, vault re-encrypted |
| Export tokens (encrypted) | ALL | Export produces file, file can be re-imported |
| Import tokens | ALL | Import from file, tokens appear in vault |
| Auto-lock | ALL | Wait for timeout, vault locks, lock screen shown |
| Settings changes persist | ALL | Change setting, lock, unlock, setting still applied |
| Lock via shortcut/menu | DESKTOP | Cmd/Ctrl+L or tray menu locks vault |
| Clipboard auto-clear | ALL | Copy code, wait for timeout, clipboard is empty |

### E2E Test Data

Maintain a set of test tokens with known secrets and expected codes at specific timestamps. The E2E test harness SHOULD be able to mock the system clock (or use known fixed timestamps) to verify code generation deterministically.

Test token set:

| Issuer | Account | Secret (Base32) | Algorithm | Digits | Period |
|--------|---------|-----------------|-----------|--------|--------|
| GitHub | test@example.com | JBSWY3DPEHPK3PXP | SHA1 | 6 | 30 |
| AWS | root | GEZDGNBVGY3TQOJQ | SHA1 | 6 | 30 |
| Google | user@gmail.com | HXDMVJECJJWSRB3HWIZR4IFUGFTMXBOZ | SHA1 | 6 | 30 |
| Custom256 | test | JBSWY3DPEHPK3PXP | SHA256 | 8 | 60 |
| Custom512 | test | JBSWY3DPEHPK3PXP | SHA512 | 6 | 30 |

---

## CI/CD Pipeline

### On Every Pull Request

```
1. Lint
   ├── cargo fmt --check
   ├── cargo clippy -- -D warnings
   ├── eslint (TypeScript)
   └── prettier --check (TypeScript/CSS)

2. Rust Tests
   ├── cargo test --workspace
   └── cargo tarpaulin (coverage check, fail if below threshold)

3. TypeScript Tests
   ├── pnpm test:ts (unit tests)
   └── coverage check (fail if below threshold)

4. Build Verification
   ├── pnpm build:desktop (verify it compiles)
   ├── pnpm build:extension (verify it builds)
   └── cargo build --workspace (Rust compiles clean)

5. Security
   ├── cargo audit (known vulnerabilities)
   └── pnpm audit (npm vulnerabilities)
```

### On Merge to Main

Everything above, plus:

```
6. E2E Tests
   ├── Desktop E2E (headless, one platform in CI — e.g., Linux)
   ├── Extension E2E (Playwright + Chrome)
   └── Mobile E2E (emulator, if CI supports it — otherwise manual gate)

7. Build Artifacts
   ├── Desktop installers (Win/Mac/Linux)
   ├── Mobile builds (APK, IPA)
   ├── Extension zip
   └── Landing page deploy
```

### On Release Tag

Everything above, plus:

```
8. Sign and Notarize
   ├── macOS: code sign + notarize
   ├── Windows: code sign
   ├── Android: sign APK/AAB
   └── iOS: sign for App Store / TestFlight

9. Publish
   ├── GitHub Release (desktop installers, extension zip)
   ├── Chrome Web Store submission
   ├── Google Play Store submission
   ├── Apple App Store submission
   └── Landing page update with new version
```

---

## Test Environment Setup

### Rust

- Stable Rust toolchain (latest)
- `cargo-tarpaulin` or `cargo-llvm-cov` for coverage
- `criterion` for benchmarks
- `proptest` for property-based testing
- `cargo-audit` for dependency vulnerability scanning
- `cargo-fuzz` for fuzzing (optional, stretch goal)

### TypeScript

- Test runner appropriate for chosen framework (Vitest recommended — fast, ESM-native)
- Component testing library appropriate for chosen UI framework
- Coverage via built-in test runner coverage (c8/istanbul)

### E2E

- Playwright for desktop and extension E2E
- Appium or framework-specific tool for mobile E2E
- Docker or native CI runners for headless execution

---

## What NOT to Test

- Do not test Tauri framework internals (window management, IPC plumbing)
- Do not test browser APIs (chrome.storage, navigator.clipboard — these are platform guarantees)
- Do not test third-party library internals
- Do not write tests that only assert the absence of TypeScript type errors (that is the type checker's job)
- Do not write snapshot tests for UI components (they are brittle and provide low value for a utility app)
